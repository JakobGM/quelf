---
title: Time used as a student
author: Jakob Gerhard Martinussen
date: April 14th, 2016
output:
  html_document:
    theme: sandstone
    df_print: paged
    code_folding: hide
    css: knitr.css
---

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(results = "hold")
knitr::opts_chunk$set(fig.fullwidth = TRUE)
knitr::opts_chunk$set(fig.width = 10)
```

# Time tracking (with Toggl)

## Data format

I have been tracking my time usage as a student since I started at the university in August 2014.
Every time I sit down with study related work I start the Toggl timer.
The time tracking is quite strict, if I have to go to the bathroom, talk with another student, etc., I stop the timer even if it is for 2 minutes.
That way I hope this data set can accurately reflect the *effective* numbers of hours I have spent studying the last 5 years.

The Toggl time entries end up looking like this:

```{r, cache = TRUE}
# Ecosystem of modern R-packages
library(tidyverse)

# For parsing JSON
library(tidyjson)

# Data pipelining functionality
library(magrittr)

# For use of `ymd_hms`
library(lubridate)

# For reshaping data frames, e.g. `spread`
library(reshape2)

# For `rollmean`
library(zoo)

# Reading JSON generated by python library
toggl_json <- read_json(path = "../data/toggl/tidy_details.json")

# Parse the JSON structure into a tidy data frame
toggl <- toggl_json %>%
  as.tbl_json() %>%
  gather_array() %>%
  spread_values(
    description = jstring("description"),
    start = jstring("start"),
    end = jstring("end"),
    study_session_duration = jnumber("dur"),
    project = jstring("project")
  ) %>%
  mutate(
    date = as.POSIXct(start),
    start = ymd_hms(start),
    end = ymd_hms(end),
    study_session_duration = study_session_duration / (1000 * 60 * 60)
  ) %>%
  rename(course = "project") %>%
  dplyr::filter(study_session_duration < 12) %>%
  select(-document.id, -array.index)

# Sanitize the descriptions into 8 main categories
toggl$description %<>%
  str_replace_all(c(
    ".*[Øø]v.*" = "Exercise",
    ".*[Ff]orelesning.*" = "Lecture",
    ".*[Tt]eori.*" = "Theory",
    ".*Eksamen.*" = "Exam",
    ".*Euler.*" = "Exercise",
    ".*Det tenkende.*" = "Theory",
    ".*Ethics.*" = "Theory",
    ".*Nedlasting.*" = "Organization",
    ".*Innlevering.*" = "Hand-in",
    ".*Lab.*" = "Hand-in",
    ".*Seminar.*" = "Lecture",
    ".*Pedag.*" = "Pedagogics",
    ".*Lære bort.*" = "Pedagogics",
    ".*Maple.*" = "Hand-in",
    ".*Theory.*" = "Theory",
    "Mattelab" = "Hand-in",
    ".*[Ll]ese.*" = "Theory",
    ".*Wunderlist.*" = "Organization",
    ".*[Kk]apittel.*" = "Theory",
    ".*[Rr]epetisjon.*" = "Repetition",
    "Inn" = "Hand-in",
    "Intervju" = "Exercise",
    "Google Calendar" = "Organization",
    "Kok" = "Hand-in",
    ".*[Oo]rganiser.*" = "Organization",
    "Anbefalte oppgaver" = "Exercise"
  ))

# Assign the remaining empty descriptions as "Hand-in"
toggl$description[toggl$description == ""] <- "Hand-in"

# Show example data in report
toggls <- dim(toggl)[1]
toggl[c(1:3, (toggls-3):toggls), c("course", "description", "start", "end", "study_session_duration")]
```

At the time of writing, `r toggls` distinct time entries have been recorded.
Each entry contains the course I have been working on, the nature of the work, and start/end datetimes.

## How many hours are tracked during a work day?

What you quickly realize when tracking your own *effective* time use, is how little of it you actually have during an average day.
To illustrate this point, let's plot the effective lengths of all my work days as a histogram grouped into half hour intervals.

```{r}
# For use of `percent_format()`
library(scales)

days <- toggl %>%
  group_by(date) %>%
  summarize(study_hours = sum(study_session_duration)) %>%
  add_column(rolling_mean = rollmean(.$study_hours, 30, na.pad=TRUE))


binwidth <- 0.5
days %>%
  ggplot() +
  aes(x = study_hours, binwidth * ..density..) +
  geom_histogram(
    aes(fill = ..density..),
    binwidth = binwidth,
    color = "white",
    show.legend = FALSE
  ) +
  geom_vline(
    aes(xintercept = mean(days$study_hours), color = "Mean"),
    size = 3
  ) +
  scale_y_continuous(labels = percent_format()) +
  scale_x_continuous(breaks = 0:12) +
  scale_color_discrete("") +
  ylab("Relative frequency")
```

I consider myself an above average student when it comes to the time I invest in my studies, but still I only track on average `r round(mean(days$study_hours), 2)` hours for the subset of days I study.
The data also portrays a large standard deviation of `r round(sd(days$study_hours), 2)`.

This might by an example of the [superiority bias](https://en.wikipedia.org/wiki/Illusory_superiority) or it may be true that most people actually overestimate their effective work hours during an average day.
Based on data gathered by other students at my university I lean towards the latter.

## What kind of work is the time spent on?

The "nature of the work" is categorized into 8 different types of work:

* **Lecture** - Listening and/or taking notes in lectures.
* **Theory** - Reading books/articles on the curriculum.
* **Hand-in** - Work on obligatory homework and projects.
* **Exercise** - Work on non-obligatory, but recommended homework.
* **Repetition** - Going over earlier theory and exercises that has been read/done before.
* **Organization** - Non-learning work, such as planning, delivering hand-ins, and printing material.
* **Exam** - Taking the final exam.

So how does the work distribute across these categories?

```{r}
toggl %>%
  group_by(description) %>%
  summarize(study_hours = sum(study_session_duration)) %>%
  ggplot() +
  aes(x = reorder(description, study_hours), y = study_hours) +
  geom_bar(stat = "identity", aes(fill = study_hours)) +
  coord_flip()
```

The work is dominated by the `Hand-in` category.
This comes as no surprise to me.
Most of the semester is spent handing in one project after another, often with little time in between.

I have had little issues with this as it is one of the most efficient ways to learn how to actually *apply* the curriculum, but it often leaves little time for exam preparations at the end of the semester.
As the criteria for a good grade on the final exam is often entirely unrelated to the material learned from obligatory projects, I often feel that the final grade does not reflect the time spent on the course.
We will come back to the relationship between time spent on a course and the final grade further down.

## Do certain type of work result in longer days?

We can try to visualize what kind of work dominates the workdays of different length.

```{r}
hours_per_day <- toggl %>%
  group_by(date) %>%
  summarize(study_hours = sum(study_session_duration))

hours_per_category_per_day <- toggl %>%
  group_by(date, description) %>%
  summarize(category_hours = sum(study_session_duration)) %>%
  ungroup()

categories_per_day <- hours_per_day %>%
  inner_join(hours_per_category_per_day) %>%
  group_by(date) %>%
  spread(description, category_hours, fill = 0)

binwidth <- 0.5
categories_per_day %>%
  gather(category, hours, colnames(.)[-c(1:2)]) %>%
  group_by(group = cut(study_hours, breaks = seq(0, 12, by=0.5))) %>%
  ungroup() %>%
  mutate(group = (as.numeric(group) - 1) / 2) %>%
  ggplot() +
  aes(x = group + 0.25) +
  aes(y = hours) +
  aes(fill = category) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 12)) +
  xlab("Length of work day") +
  ylab("Total hours spent")
```

The conclusion that can be drawn from this plot is that the longer the days, the more probable it is that most of it has been spent on obligatory hand-ins.
Most projects last for two/three weeks, and in order to get a good grade it often requires full time work on at least half of those days (from personal experience).
Taking into account that I have to attend 3 other courses at the same times, some of them even with their own projects, it often leads to quite long work days.

## Trend of work over time

Until now we have only looked at aggregate statistics, but has the amount of work changed over time?

```{r, fig.height = 4}
# For `rollmean`
library(zoo)

sick_leave <- tibble(
  interval = c(
    as.POSIXct("2017-12-14 23:00:00 UTC"),
    as.POSIXct("2018-08-03 23:00:00 UTC")
  )
)

days %>%
  ggplot() +
  geom_ribbon(
    data = sick_leave,
    aes(
      x = interval,
      ymin = 0,
      ymax = Inf,
      y = 1,
      fill = "RSI sick leave"
    ),
    alpha = 0.5
  ) +
  geom_vline(
    aes(
      xintercept = as.POSIXct("2016-01-15 23:00:00 UTC"),
      linetype = "RSI problems start"
    ),
    color = colors$red
  ) +
  aes(x = date, y = study_hours) +
  geom_point(aes(color = study_hours), show.legend = FALSE) +
  geom_smooth(linetype = "dashed") +
  xlab("Day") +
  ylab("Work hours") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_fill_manual("", values = colors$red) +
  scale_linetype_manual("", values = c(1)) +
  theme(legend.position = "bottom")
```

My studies at the university started with quite long days.
The work was unfamiliar and required long days; I remember often sitting from 8AM to 8PM in the computer lab.
As I grew more confident over time, the required work decreased.

That continued for 3 semesters until I got a bad case of [repetitive stress injury](https://en.wikipedia.org/wiki/Repetitive_strain_injury) in January, 2016.
I had been working too much with too few breaks and that eventually had its consequences.
The RSI issues continued for a long time, getting worse and worse, culminating in a doctor-recommended sick leave in December, 2017.
I had to drop out of my studies right before my final exams and take the entire next semester off, effectively setting me back one year.

After the long break I finally got better and became able to use my hands again.
Since then I have been slowly increasing the work load, hopefully with more care taken with respect to my health.

# Grades

My grade statistics are also available:

```{r}
grades <- tibble(
    course = toggl %>%
      select(course) %>%
      unique() %>%
      arrange(course) %>%
      unlist(),
    course_code = c(
      "EXPH0004", "Org", "TDT4102", "TDT4105", "TDT4120", "TDT4136", "TDT4145",
      "TEP4105", "TFY4145", "TFY4155", "TFY4165", "TFY4215", "TIØ4146",
      "TIØ4258", "TMA4100", "TMA4105", "TMA4115", "TMA4120", "TMA4145",
      "TMA4150", "TMA4180", "TMA4195", "TMA4212", "TMA4215", "TMA4245",
      "TMA4265", "TMA4267", "TMA4268", "TMA4295", "TMA4300", "TMA4315",
      "TMA4320", "TMA4850", "TMT4110"
    ),
    grade = as.ordered(c(
      "A", NA, "A", "A", "A", NA, NA, "B", "A", "A", "B", NA, "A", "B", "A", "A",
      "A", "B", "C", NA, "C", "C", "C", "C", "A", "D", "B", NA, NA, NA, "A", "B",
      NA, "B"
    )),
    semester = c(
      1, NA, 4, 1, 5, 7, 10, 3, 1, 2, 3, 10, 9, 3, 1, 2, 2,
      3, 5, 6, 6, 9, 6, 9, 4, 5, 6, 10, 5, 10, 9, 4, 10, 2
    )
  ) %>%
  arrange(semester)

# Print the entire tibble
grades
```

## Relation between time spent and final grade

```{r}
theme_set(theme_minimal() + theme(legend.position = "bottom"))
colors <- list(
  green = "#536D3D",
  light_green = "#9AB73C",
  orange = "#E5D017",
  dark_orange = "#E59E15",
  red = "#DB4801"
)

courses <- toggl %>%
  group_by(course) %>%
  summarize(study_hours = sum(study_session_duration)) %>%
  inner_join(grades)

courses %>%
  ggplot() +
  aes(x = reorder(course_code, -study_hours), y = study_hours) +
  geom_bar(stat = "identity", aes(fill = grade)) +
  coord_flip() +
  theme(legend.position = "bottom") +
  scale_fill_manual(
    values = as.vector(unlist(colors)),
    na.value="gray"
  ) +
  ylab("Time spent  [hours]") +
  xlab("") +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
  )
```

## Trend of work amount and grades over time

```{r, fig.cap = "The red lines delineate each semester."}
courses %>%
  ggplot() +
  aes(x = reorder(course_code, semester), y = study_hours) +
  geom_bar(stat = "identity", aes(fill = grade)) +
  geom_vline(xintercept = 4.5, color = colors$red) +
  geom_vline(xintercept = 8.5, color = colors$red) +
  geom_vline(xintercept = 12.5, color = colors$red) +
  geom_vline(xintercept = 15.5, color = colors$red) +
  geom_vline(xintercept = 18.5, color = colors$red) +
  geom_vline(xintercept = 23.5, color = colors$red) +
  geom_vline(xintercept = 24.5, color = colors$red) +
  geom_vline(xintercept = 28.5, color = colors$red) +
  theme(legend.position = "bottom") +
  scale_fill_manual(
    values = as.vector(unlist(colors)),
    na.value="gray"
  ) +
  xlab("") +
  ylab("Time spent  [hours]") +
  theme(axis.text.x = element_text(angle = 90))
```

## Does the type of work matter for the final grade?

```{r}
library(RColorBrewer)
toggl %>%
  group_by(course, description) %>%
  summarize(time = sum(study_session_duration)) %>%
  ungroup() %>%
  right_join(grades) %>%
  filter(!is.na(grade)) %>%
  group_by(grade, description) %>%
  summarize(time = sum(time)) %>%
  ggplot() +
  aes(x = grade, y = time, fill = description) +
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Spectral")
```

# Sleep

```{r, cache = TRUE}
# For use of `str_extract`
library(stringr)

#--- Importing SleepCycle data ---#
sleep_json <- read_json(path = "../data/sleep_sessions.json")
sleep <- sleep_json %>%
  as.tbl_json() %>%
  enter_object("sleep_sessions") %>%
  gather_keys() %>%
  spread_values(
    start_date = jstring("start_local"),
    stop_date = jstring("stop_local"),
    date = jstring("stop_local"),
    start = jstring("start_local"),
    stop = jstring("stop_local"),
    wakeup_mood = jnumber("rating"),
    heartrate = jstring("heartrate"),
    sleep_quality = jnumber("stats_sq"),
    sleep_duration = jnumber("stats_duration"),
    steps = jstring("steps"),
    sleep_notes = jstring("sleep_notes")
  ) %>%
  mutate(
    heartrate = str_extract(heartrate, "\\d+") %>% as.numeric(),
    steps = str_extract(steps, "\\d+") %>% as.numeric(),
    date = as.POSIXct(date),
    start_date = as.POSIXct(start_date),
    stop_date = as.POSIXct(stop_date),
    start = ymd_hms(start),
    stop = ymd_hms(stop),
    sleep_duration = sleep_duration / (60 * 60)
  ) %>%
  select(-document.id, -key) %>%
  add_column(source = "iOS")


#--- Converting sleep notes ---#
sleep_notes <- sleep$sleep_notes %>%
  str_split(pattern = ", ")

note_categories <- sleep_notes %>%
  unlist() %>%
  unique() %>%
  extract(-1)

for (note_category in note_categories) {
  if (note_category %in% colnames(sleep)) break

  boolean_vector <- vector()
  for (sleep_note in sleep_notes) {
    has_note <- note_category %in% sleep_note
    boolean_vector <- c(boolean_vector, has_note)
  }

  sleep[[note_category]] <- boolean_vector
}


#--- Importing Sleep as Android data ---#
android_json <- read_json(path = "../data/sleep/android.json")
android <- android_json %>%
  as.tbl_json() %>%
  gather_array() %>%
  spread_values(
    start = jstring("from"),
    stop = jstring("to"),
    sleep_duration = jnumber("hours")
  ) %>%
  mutate(
    start = dmy_hm(start),
    stop = dmy_hm(stop)
  ) %>%
  mutate(
    date = as.POSIXct(stop),
    start_date = as.POSIXct(start),
    stop_date = as.POSIXct(stop)
  ) %>%
  add_column(source = "Android") %>%
  select(-document.id, -array.index)

if (!("Android" %in% sleep$source)) {
  sleep %<>% bind_rows(android)
}

# Add the final data set to the day summary data
days %<>% full_join(sleep, by = "date")

# Show part of data in report
sleeps <- dim(sleep)[1]
sleep[100:105, c("start", "stop", "Drank coffee", "RSI Pains")]
```

## Part of the spent sleeping

```{r, fig.fullwidth = TRUE, fig.width = 20, fig.height = 5}
time_of_day <- trans_new(
  "time_of_day",
  transform = function(x) {(x - 18) %% 24},
  inverse = function(x) {(x + 18) %% 24},
  breaks = function(x) {1:24}
)

sleep %>%
  mutate(
    in_bed = ((hour(start) + minute(start) / 60)),
    out_of_bed = ((hour(stop) + minute(stop) / 60))
  ) %>%
  ggplot() +
  aes(x = stop_date) +
  geom_segment(
    aes(
      x = stop_date,
      xend = stop_date,
      y = in_bed,
      yend = out_of_bed,
      color = sleep_duration
    )
  ) +
  geom_smooth(
    aes(y = in_bed, linetype = "Going to bed"),
    fill = "#E59E15",
    color = "#77AB43",
    alpha = 0.3
  ) +
  geom_smooth(
    aes(y = out_of_bed, linetype = "Out of bed"),
    fill = "#E59E15",
    color = "#77AB43",
    alpha = 0.3
  ) +
  scale_y_continuous(
    name = "Time of day",
    trans = time_of_day
  ) +
  scale_linetype_manual(
    values = c("dotted", "dashed"),
    name = "Sleep trend",
    labels = c("Going to bed", "Waking up")
  ) +
  theme(legend.position = "bottom") +
  theme_minimal()
```

## Sleep duration duration over time

```{r, fig.width = 16, fig.height = 9}
sleep %>%
  mutate(rolling_mean = rollmean(sleep_duration, 30, na.pad = TRUE)) %>%
  filter(sleep_duration > 4) %>%
  ggplot() +
  aes(x = date, y = sleep_duration) +
  geom_point(aes(color = sleep_duration), alpha = 0.5) +
  geom_smooth(size = 3) +
  geom_line(aes(y = rolling_mean)) +
  scale_y_continuous(breaks = 1:15)
```

## Correlation between work amount and sleep duration

```{r}
days %<>% inner_join(sleep, by = "date")
model <- lm(study_hours ~ sleep_duration, data = days)
days %>%
  select(sleep_duration, study_hours) %>%
  filter(sleep_duration > 5) %>%
  ggplot() +
  aes(x = sleep_duration, y = study_hours) +
  geom_point() +
  stat_smooth(method = "lm")
```


<style>
img {
    max-width: 100vw;
    position: relative;
    left: 50%;
    -moz-transform: translateX(-50%);
    -webkit-transform: translateX(-50%);
    transform: translateX(-50%);
}
</style>
